rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      // For production, use custom claims. This is for development.
      return isSignedIn() && request.auth.token.email == "isaacmargues03@gmail.com";
    }

    // Grant admins full read/write access to user documents.
    // Users can only access their own.
    match /users/{userId} {
      allow read, write: if isAdmin() || (isSignedIn() && request.auth.uid == userId);
    }
    
    // Grant users full read/write access to all documents under their own user path.
    // Admins are also granted full access to all user data for management.
    match /users/{userId}/{document=**} {
      allow read, write: if isAdmin() || (isSignedIn() && request.auth.uid == userId);
    }

    // Rules for withdrawal requests, managed by users and processed by admins.
    match /withdrawalRequests/{requestId} {
      function isRequestOwner() {
        // On create, check incoming data. On read, check existing data.
        return (request.method == 'create' && request.auth.uid == request.resource.data.userId)
            || (resource != null && request.auth.uid == resource.data.userId);
      }
      
      // Admins have full read/write permissions to manage all requests.
      allow read, write: if isAdmin();
      
      // Users can create and read their own requests.
      allow create: if isRequestOwner();
      allow get: if isRequestOwner();
      
      // Users cannot list all requests, update, or delete them.
      allow list, update, delete: if false;
    }
  }
}
